langText = {
    "#EventButton": {
        "en": "Wedding events",
        "tw": "婚禮資訊"
    },
    "#StoryButton": {
        "en": "Our story",
        "tw": "我們的故事"
    },
    "#FactButton": {
        "en": "Fun facts",
        "tw": "小趣事"
    },
    "#PhotoButton": {
        "en": "Photo gallery",
        "tw": "相簿"
    },
    "#TextMarry": {
        "en": "Ting-Wei & Hsiang-Chih are getting married!",
        "tw": "亭維 & 翔致要結婚了！"
    },
    ".weddingHeader": {
        "en": "Wedding events",
        "tw": "婚禮資訊"
    },
    "#TextDateHeader": {
        "en": "Date",
        "tw": "日期"
    },
    "#TextDate": {
        "en": "December 18, 2022 (Sunday)",
        "tw": "2022年12月18日 (星期日)"
    },
    "#TextCeremonyHeader": {
        "en": "Ceremony:<br>Chi-Nan Presbyterian Church",
        "tw": "結婚典禮(自由參加):<br>濟南教會 <br> "
    },
    "#TextChurch": {
        "en": "3:00 pm starts sitting, 3:30 pm event begins.<br> \
               No. 3, Zhongshan S Rd, Zhongzheng District, Taipei City <br> \
               Google map: <a target=\"_blank\" href=\"https://goo.gl/maps/NZJXJdLBwn2jZuGj6\">Link</a> <br>\
               Close to MRT NTU Hospital, Shandao Temple, and Taipei Main station",
        "tw": "3:00 pm入場，3:30 pm典禮開始 <br> \
               台北市中正區中山南路3號 <br> \
               Google 地圖 <a target=\"_blank\" href=\"https://goo.gl/maps/NZJXJdLBwn2jZuGj6\">連結</a><br>\
               近捷運台大醫院站、善導寺站、台北車站"
    },
    "#TextBanquetHeader": {
        "en": "Banquet: <br> Mandarin Oriental Taipei",
        "tw": "婚禮晚宴:<br>臺北文華東方酒店"
    },
    "#TextBanquet": {
        "en": "6:00 pm starts sitting, 6:30 pm event begins.<br> \
               No. 158, DunHua N Rd, Songshan District, Taipei City <br> \
               Google map: <a target=\"_blank\" href=\"https://goo.gl/maps/15nu7y7u53WyiVUk7\">Link</a> <br>\
               Close to MRT Taipei Arena station",
        "tw": "6:00 pm入場，6:30 pm晚宴開始<br> \
               台北市松山區敦化北路158號<br> \
               Google 地圖<a target=\"_blank\" href=\"https://goo.gl/maps/15nu7y7u53WyiVUk7\">連結 </a>  <br>\
               近捷運台北小巨蛋站"
    },
    "#TextTransHeader": {
        "en": "Recommended transportation",
        "tw": "建議交通方式"
    },
    "#TextTrans": {
        "en": "If you attend the ceremony around the church, we recommend public transportation due to the limited partking space at the church, If you want to take MRT from the church to the hotel, we recommend taking the red line to the Da-an station, then the brown line to the Nanjing Fuxing station, then the green line to the Taipei Arena station; the estimated MRT transportation time is 40 minutes. If you only attend the banquet at the hotel, you can use the free parking at the hotel (B5/B6).",
        "tw": "如參加教會典禮，因車位有限，建議多利用大眾交通工具。如欲從教會搭捷運至文華東方酒店，建議搭乘紅線、由台大醫院站搭至大安站，轉乘文湖線、搭至南京復興，再轉乘綠線搭至台北小巨蛋站；總捷運車程約40分鐘。如僅參加婚宴，可多利用酒店的免費停車場(於酒店B5/B6)。"
    },
    "#TextParkingHeader": {
        "en": "Parking",
        "tw": "停車資訊"
    },
    "#TextParking": {
        "en": "Parking spaces nearby the Chi-Nan Presbyterian Church: <a target=\"_blank\" href=\"http://www.chi-nanchurch.tw/contact/venue/parking-nearby\">link </a> <br>\
        The Mandarin Oriental Taipei provides free parking at the hotel B5 and B6\
        ",
        "tw": "濟南教會附近計時停車場請參考：<a target=\"_blank\" href=\"http://www.chi-nanchurch.tw/contact/venue/parking-nearby\">連結 </a> <br>\
        臺北文華東方酒店提供免費室內停車(於酒店B5/B6)"
    },
    "#TextZoomHeader": {
        "en": "Zoom link",
        "tw": "Zoom 連結"
    },
    "#TextZoom": {
        "en": "Links will be available in near future!",
        "tw": "線上Zoom連結會於近期更新！"
    },
    ".storyHeader": {
        "en": "Our story",
        "tw": "我們的故事"
    },
    "#TextStory1": {
        "en": "Once upon the time, Ting-Wei and Hsiang-Chih, both Taiwanese. They both grew up in Taipei, but never met each other.",
        "tw": "很久很久以前，亭維和翔致都是台北人，但他們並沒有在台灣相遇。"
    },
    "#TextStory2": {
        "en": "Hsiang-Chih, a nature lover, loves to travel around the world, and also stargazing. One of his most proudest things is he went to Tibet in 2014, counting stars with Mt. Everest. Maybe that’s how he ended up with his astronomy career later?",
        "tw": "翔致熱愛自然，喜歡旅遊及觀星。他曾經去過西藏的喜馬拉雅山基地營看星星。這或許是為什麼後來翔致走上天文研究的原因？"
    },
    "#TextStory3": {
        "en": "Ting-Wei is an enthusiastic music lover. She sings with playing piano or guitar. She writes songs on her own. Want to listen to one? Here you go: youtube link",
        "tw": "亭維熱愛音樂。她能自彈(鋼琴和吉他)自唱，甚至還會自己寫歌。想聽聽她的作品嗎？這裡是連結！"
    },
    "#TextStory4": {
        "en": "Ting-Wei and Hsiang-Chih met each other in Baltimore, 2016. Well, they didn’t get close to each other right away, until they started to play badminton together! (Oh btw, Hsiang-Chih was a captain of the badminton team in his undergrad department) <br> Then, they found that they were not only good teammates on the badminton court but also in life! Therefore, they became a couple in summer, 2017! ",
        "tw": "2016年，亭維和翔致在美國巴爾的摩求學時相遇。但大概是在半年後，他們才因一起打羽球才變熟(翔致表示，還好以前在大學系上羽球隊沒白費)。 <br>日後，他們發現，他們不僅是羽球場上的好隊友，他們還可以一起玩音樂、划船、數星星。最後，在2017年的夏天，他們成了情侶!"
    },
    "#TextStory5": {
        "en": "It has been six years since Ting-Wei and Hsiang-Chih were together. Their daily life is full of funny moments. During the Covid, they witnessed Hsiang-Chih’s super long beard, as well as the fantastic comet in 2020. Hsiang-Chih often wolfed down the snacks, but not allowing Ting-Wei to do the same thing. Hsiang-Chih would also tell Ting-Wei not to sit with crossed legs, saying that it’s not good for her knees. <br>Anyway, they seem to enjoy a lot their daily life! ",
        "tw": "不知不覺，從在一起到現在，亭維和翔致邁入了第6年。生活上也是滿滿的點滴。在covid 期間，他們一起見證了翔致超級長的鬍子，跟難得一見的彗星。或者翔致常常吃零食都很大口，但又叫亭維不能學他。或者翔致會囉唆的叫亭維不能盤腿、對膝蓋不好...<br>總之，他們似乎生活上的點點滴滴也是充滿著樂趣！"
    },
    "#TextStory6": {
        "en": "After Hsiang-Chih finished his PhD in astronomy in 2021. Before moving to Princeton for their new jobs, they had a trip to Alaska, where their arms were completely exhausted after 5-hour kayaking. <br>They thought it is time for next chapter of their life.. Hsiang-Chih proposed to Ting-Wei on Feb. 12, 2022, promising that they will face the joy and difficulty together, and will get old together with laughter. <br>Ting-Wei said yes :) ",
        "tw": "2021年，翔致博士班畢業後，亭維跟翔致一起去了一趟阿拉斯加，在冰川邊划船，然後晚上兩人手臂再痠到不行。<br>後來，翔致搬去普林斯頓工作，並決定是時候完成人生大事。2022年2月12日，翔致向亭維求婚，承諾兩人要在接下來人生的日子裡，一起面對歡樂與困難，然後一起笑著變老。<br><br>亭維說 yes! :)"
    },
    "#TextStory7": {
        "en": "Ting-Wei and Hsiang-Chih will have their wedding on Dec. 18, 2022. Please come and celebrate the big moment of their lives! Your presence means a lot to us!! ",
        "tw": "在成為情侶後第6年，亭維和翔致決定在2022年12月18日步入禮堂。誠摯地邀請您與我們一起見證這意義重大的一刻！"
    },
    ".factHeader": {
        "en": "Fun facts",
        "tw": "小趣事"
    },
    "#TextFact1": {
        "en": "Do these strange animals have names? <br> <br> Yes! Their names are Jabu and Duki! The actual meanings of these names remain unclear. Jabu is often mistaken as an octopus (or its kind), but Jabu is definitely not an octopus. ",
        "tw": "這兩個生物有名字嗎？<br><br>有！他們的名字是Jabu和Duki。名字的意思不明。順帶一提，Jabu並不是章魚(也不是類似章魚的生物)。"
    },
    "#TextFact2": {
        "en": "When is the “birthday” of Jabu? <br> <br>It is currently unknown. Based on Archeology, the earliest Jabu-related product was dated back to ~2005, when Hsiang-Chih was in his middle school. Since this Jabu product is already very mature, Jabu likely has been existent a few years before 2005. <br>Btw, Hsiang-Chih also uses Jabu as his signature in his credit card payment. ",
        "tw": "Jabu 是什麼時候誕生的？<br><br>Jabu的誕生日已不可考。但根據考古資料，目前最早的Jabu相關產品(下圖)可追溯至~2005年、翔致國中的美術課作業。但這個成品已展現 Jabu 作畫的高度成熟性，因此推估Jabu應於數年前就已誕生。<br>順帶一提，翔致現在的信用卡簽名也是用Jabu。"
    },
    "#TextFact3": {
        "en": "When is the “birthday” of Duki? <br> <br>The concept of Duki was first created in 2017, by Hsiang-Chih. But the drawing of Duki has been significantly improved (?) by Ting-Wei. In fact, Hsiang-Chih is not as good at drawing Duki due to its complexity.  ",
        "tw": "Duki 是什麼時候誕生的？<br><br>第一個Duki是翔致於 2017年時畫的(下方左圖)。但現今的Duki已經過亭維大量的改良。其實，因為Duki較複雜的結構，翔致不太擅長畫Duki。"
    },
    "#TextFact4": {
        "en": "How is this website being made? <br><br>This website is made by Po-Hsien (tremendous technical help), Ting-Wei (all the drawing), and Hsiang-Chih (content)!",
        "tw": "這網站是如何製作的呢？<br><br>這網站是由柏軒(大量的技術支援)、亭維(所有作圖)、翔致(內容)完成！"
    },
    "#TextPhotoHeader": {
        "en": "Photo gallery",
        "tw": "(真人)相簿"
    },
    "#TextPhoto": {
        "en": "Now it is time for some real-person photos!",
        "tw": "看完Jabu跟Duki，是時候看看真人版的照片了！"
    },
}

var makeStruct = function(names) {
    var names = names.split(" ");
    var count = names.length;

    var constructor = function() {
        for (var i = 0; i < count; i++) {
            this[names[i]] = arguments[i];
        }
    }
    return constructor;
}

var ScrollConfig = makeStruct("selector initialScale finalScale height");
var _updateConfig = []

var animateUpdate = function() {
    var scroll = window.scrollY

    if (scroll >= $("#WeddingEvent0").offset().top && scroll < $("#OurStory0").offset().top) {
        $("#EventButton").addClass("active")
        $("#StoryButton").removeClass("active")
        $("#FactButton").removeClass("active")
        $("#PhotoButton").removeClass("active")
    }
    if (scroll >= $("#OurStory0").offset().top - 1 && scroll < $("#Facts0").offset().top) {
        $("#EventButton").removeClass("active")
        $("#StoryButton").addClass("active")
        $("#FactButton").removeClass("active")
        $("#PhotoButton").removeClass("active")
    }
    if (scroll >= $("#Facts0").offset().top - 1 && scroll < $("#Photo").offset().top) {
        $("#EventButton").removeClass("active")
        $("#StoryButton").removeClass("active")
        $("#FactButton").addClass("active")
        $("#PhotoButton").removeClass("active")
    }
    if (scroll >= $("#Photo").offset().top - 1) {
        $("#EventButton").removeClass("active")
        $("#StoryButton").removeClass("active")
        $("#FactButton").removeClass("active")
        $("#PhotoButton").addClass("active")
    }

    _updateConfig.forEach((config) => {
        var containerTop = $(config.selector).offset().top
        var element = $(config.selector).find(".shrinkElement")
        if (scroll < containerTop) {
            scale = config.initialScale
            element.css("position", "absolute")
            element.css("top", containerTop + $(".sticky-top").height())
        } else if (scroll < containerTop + config.height) {
            scale = config.initialScale + (scroll - containerTop) / config.height * (config.finalScale - config.initialScale)
            element.css("position", "fixed")

            magicshift = 0.5 * config.height * (config.initialScale - scale)
            magicshift_factor = 0.7
            element.css("top", $(".sticky-top").height() - magicshift * magicshift_factor)
        } else {
            scale = config.finalScale
            element.css("position", "absolute")
            magicshift = 0.5 * config.height * (config.initialScale - config.finalScale)
            magicshift_factor = 0.7
            element.css("top", containerTop + config.height + $(".sticky-top").height() - magicshift * magicshift_factor)
        }
        element.css("transform", `scale(${scale})`)
        invisible = $(config.selector).find(".invisible-block")
        invisible.css("height", config.height + element.height())
    })
}

var ScrollShrink = function(config) {
    var element = $(config.selector)
    var shrinkElement = $(element).find(".shrinkElement")
    if (shrinkElement.length == 0) {
        alert("No shrinkElement found under " + config.selector)
    }
    config.height = element.height()

    _updateConfig.push(config)
    animateUpdate()
}

var langChange = function(lang) {
    for (id in langText) {
        $(id).html(langText[id][lang])
    }
    changePhotoCaption(lang)
}

var changePhotoCaption = function(lang) {
    $('#PhotoCaption').html($($("#Carousel img")[Math.floor(currentCarouselIndex)]).attr(lang + "-data"))
}

var modalShowImg = function(url) {
    $("#myModal").show()
    $("#imginmodal").attr("src", url)
}

var lazyloadObject = lazyload()
var currentCarouselIndex = 0
var touchLastLoc = undefined
var moveCarousel = function(selected, {
    itemsRow = 5, // number of items per row
    zIndex = true, // change z-index based on the position
    grayscale = true, // change grayscale based on the position
    scale = true, // change scale based on the position
} = {}) {
    var items = $("#Carousel").children()
    if (selected < 0 || Math.ceil(selected) >= items.length) {
        console.log(`Not valid select: ${selected}`)
        return
    }

    paddingStep = 100 / (itemsRow - 1)
    halfItem = Math.floor(itemsRow / 2)
    items.each(function(idx, item) {
        idxDiff = idx - selected
        if (zIndex) {
            let zIndex = 500 - Math.floor(Math.abs(idxDiff) * 10)
            $(item).css("z-index", zIndex)
        }

        if (grayscale) {
            let grayscale = Math.abs(idxDiff) * 1 / (halfItem + 1)
            $(item).css("filter", `grayscale(${grayscale < 0 ? 0 : grayscale})`)
        }

        targetScale = 1
        if (scale) {
            targetScale = 1 - Math.abs(idxDiff) * 0.1
        }

        cursor = "pointer"
        if (idx == selected) {
            cursor = "zoom-in"
        }

        $(item).css({
            "left": `${50 + paddingStep * idxDiff}%`,
            "transform": `translateY(0%) translateX(-50%) scale(${targetScale})`,
            "cursor": cursor,
        })
    })
    currentCarouselIndex = selected
    if ($("#mandarinButton > a").hasClass("active")) {
        changePhotoCaption("tw")
    } else if ($("#englishButton > a").hasClass("active")) {
        changePhotoCaption("en")
    }
}

var accumulated_carousel_scroll = 0
var carousel_scroll_threshold = 100
var initialize = function() {
    $("#mandarinButton").click(function() {
        langChange("tw");
        $(this).children("a").addClass("active");
        $(this).siblings().children("a").removeClass("active");
    }).click()

    $("#englishButton").click(function() {
        langChange("en");
        $(this).children("a").addClass("active");
        $(this).siblings().children("a").removeClass("active");
    })

    // Setup Carousel
    $("#Carousel div").click(function(e) {
        if (currentCarouselIndex == $(this).index()) {
            modalShowImg($(this).children("img").attr("src"))
        } else {
            moveCarousel($(this).index())
        }
    })
    $("#Carousel div").on('wheel', function(e) {
        // console.log(e.originalEvent)
        console.log("DeltaX: ", e.originalEvent.deltaX)
        console.log("DeltaY: ", e.originalEvent.deltaY)


        accumulated_carousel_scroll += e.originalEvent.deltaX + e.originalEvent.deltaY

        console.log("accumulated_carousel_scroll: ", accumulated_carousel_scroll)
        // if (e.DeltaX / 120 > 0) {
        if (accumulated_carousel_scroll < -carousel_scroll_threshold) {
            moveCarousel(currentCarouselIndex - 1)
            accumulated_carousel_scroll = 0
        } else if (accumulated_carousel_scroll > carousel_scroll_threshold) {
            moveCarousel(currentCarouselIndex + 1)
            accumulated_carousel_scroll = 0
        }
        // Don't scroll the browsing window
        return false;
    })
    $("#Carousel div").on('touchstart', function(e) {
        if (e.originalEvent.touches.length > 1) return
        touchLastLoc = e.originalEvent.touches[0]
    }).on('touchmove', function(e) {
        if (e.originalEvent.touches.length > 1) return
        touch = e.originalEvent.touches[0]
        moveIdx = (touch.clientX - touchLastLoc.clientX) / ($("#Carousel div").width() / 2)
        window.requestAnimationFrame(function() {
            moveCarousel(currentCarouselIndex - moveIdx)
        })
        touchLastLoc = e.originalEvent.touches[0]
    }).on('touchend', function(e) {
        touchLastLoc = undefined
        window.requestAnimationFrame(function() {
            moveCarousel(Math.round(currentCarouselIndex))
        })
    })
    moveCarousel(currentCarouselIndex)

    $("img.modalable").click(function() {
        modalShowImg($(this).attr("src"))
    })

    $("#myModal > .close, #myModal").click(function() {
        $("#myModal").hide()
    })

    if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual"
    }

    $(".sticky-top-blank").height($(".sticky-top").height())

    // The following needs to be set based on the html flow.
    ScrollShrink(new ScrollConfig("#Cover", 0.9, 0.6))
    ScrollShrink(new ScrollConfig("#WeddingEvent0", 1, 0.6))
    ScrollShrink(new ScrollConfig("#WeddingEvent1", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory0", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory1", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory2", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory3", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory4", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory5", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory6", 1, 0.6))
    ScrollShrink(new ScrollConfig("#OurStory7", 1, 0.6))
    ScrollShrink(new ScrollConfig("#Facts0", 1, 0.6))
    ScrollShrink(new ScrollConfig("#Facts1", 1, 0.6))
    ScrollShrink(new ScrollConfig("#Facts2", 1, 0.6))
    ScrollShrink(new ScrollConfig("#Facts3", 1, 0.6))
    ScrollShrink(new ScrollConfig("#Facts4", 1, 0.6))

    $(window).on("resize", () => window.requestAnimationFrame(animateUpdate))
    $(document).on("scroll", () => window.requestAnimationFrame(animateUpdate))
}

$(document).ready(initialize);
$(window).on("load", function() {
    // windows is ready. Force load everything
    lazyloadObject.loadImages()

    // Make the scrollbar appears again.
    $("body").css("overflow", "inherit")
    $("#Loading").fadeOut({
        "duration": 600,
        "complete": function() {
            $(this).remove()
        }
    })
})